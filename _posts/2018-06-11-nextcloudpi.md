---
title:  "cómo levanté nextcloud en mi raspberrypi"  
layout: post  
date:   2018-06-11  
category: blog  
author: jartigag  
tag:
- raspberrypi  
- nextcloud  
- dns
---

![]({{site.baseurl}}/assets/images/posts/nextcloudpi.png)  
> Nextcloud: como Dropbox o Drive, pero manteniendo tus datos en tu propio servidor

## /índice:

- [¿NextcloudPi?](#nextcloudpi)
- [Pasos](#pasos)
	- [Instalar NextcloudPi](#instalar-nextcloudpi)
	- [Configurar acceso desde Internet](#configurar-acceso-desde-internet)

# ¿NextcloudPi?

[NextcloudPi](https://ownyourbits.com/nextcloudpi/) es una instancia de [Nextcloud](https://nextcloud.com/), la plataforma de código abierto para almacenar/compartir archivos, que viene preparada para funcionar en una [Raspberry Pi](https://www.raspberrypi.org/) y ser fácil de configurar y mantener. Su autor es [nachoparker](https://github.com/nachoparker), que ha desarrollado y mantenido NextcloudPi desde [2017](https://ownyourbits.com/2017/02/13/nextcloud-ready-raspberry-pi-image/). Hace poco rebautizó el proyecto como [NextCloudPlus](https://ownyourbits.com/2018/04/21/nextcloudpi-renamed-to-nextcloudplus-gets-a-new-website-improved-ncp-web-docker-languages-and-more/).

# Pasos

Tal y como se explica en la web, se puede [descargar NextcloudPi directamente](https://ownyourbits.com/downloads/) (y además [soporta varios sistemas](https://ownyourbits.com/nextcloudpi/#supported_systems)), pero estos son los pasos que seguí yo para instalarlo manualmente:

## Instalar NextcloudPi

1. **Descargar** [Raspbian Stretch **Lite**](https://www.raspberrypi.org/downloads/raspbian/)

2. **Grabar la imagen** en la tarjeta SD  
`sudo dd bs=4M if=2018-04-18-raspbian-stretch-lite.img of=/dev/mmcblk0 conv=fsync status=progress`

3. En la partición /boot de la tarjeta SD, crear un **archivo vacío** llamado '**ssh**'

4. **Antes de encender** la RasPi y conectarla al router por cable Ethernet,  
	`sudo nmap -sP 192.168.1.*`  
   **Después** repetir el comando, y **ver qué nueva IP** ha aparecido

5. Conectarse a la RasPi por **ssh**
 `ssh pi@192.168.1.XX` (IP de la RasPi), con contraseña 'raspberry'

6. Instalar NextcloudPi mediante el script '**install.sh**'  
`wget https://raw.githubusercontent.com/nextcloud/nextcloudpi/master/install.sh`,  
`sudo bash install.sh` [cuesta unos 20 minutos]

7. Configurar las **herramientas** que incluye NCP con `sudo ncp-config` ([Configuration Reference](https://github.com/nextcloud/nextcloudpi/wiki/Configuration-Reference))

![]({{site.baseurl}}/assets/images/posts/ncp-config.png)

¡Importante usar **dnsmasq** si nuestro router no soporta [NAT loopback](https://ownyourbits.com/2017/03/09/dnsmasq-as-dns-cache-server-for-nextcloudpi-and-raspbian/)! A mí me dio [bastantes problemas](https://twitter.com/jartigag/status/1006150496355278848)..

## Configurar acceso desde Internet

Aprovechando que [Github Education](https://education.github.com/pack/) regala el registro de un dominio .me durante un año por ser estudiante, lo usé para acceder a mi nube con una URL fácil de recordar:

8. Desde el panel de configuración del router (http://192.168.1.1/), **port-forwarding** de los puertos 80 y 443 desde la IP de la RasPi.

9. En [Namecheap](https://www.namecheap.com/), activar Dynamic DNS, registro **'A+DynDNS nextcloud 127.0.0.1 1min'** y copiar contraseña para usar en `ddclient`

10. Configurar [DNS Dinámico](https://www.namecheap.com/support/knowledgebase/article.aspx/583/11/how-do-i-configure-ddclient) con **ddclient**
   (comprobar con `traceroute nextcloud.jartigag.me`):

```
# Configuration file for ddclient generated by debconf
#
# /etc/ddclient.conf
use=web, web=dynamicdns.park-your-domain.com/getip
protocol=namecheap
server=dynamicdns.park-your-domain.com
login=jartigag.me
password=c0ntr4s3ñ4d3N4m3ch34p
nextcloud
daemon=3600
```

La configuración con otros registradores de dominios ([gra](https://ownyourbits.com/2017/03/05/dynamic-dns-for-raspbian-with-no-ip-org-installer/)-[tu](https://ownyourbits.com/2017/09/05/nextcloudpi-gets-freedns-better-automount-notifications-samba-and-web-improvements/)-[i](https://ownyourbits.com/2017/09/29/nextcloudpi-updated-to-nc-12-0-3-brings-wizard-duckdns-and-more/)-[tos](https://ownyourbits.com/2017/11/12/nextcloudpi-gets-new-look-and-feel-redis-spdns-support-berryboot-support-debian-installer-and-more/) o de pago) es similar.

Si una vez propagados los cambios se puede acceder desde fuera de la LAN pero no a través de nuestro router doméstico, probablemente sea problema del NAT loopback. Para solucionarlo, tenemos que activar dnsmasq y ponernos **como servidor DNS la propia Raspberry**:  
```
# /etc/resolv.conf
nameserver 192.168.1.XX # (IP de la RasPi)
nameserver 8.8.8.8 # (Servidor DNS secundario)
```
![]({{site.baseurl}}/assets/images/posts/nextcloud-jartigag.png)
